<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kiwi Kart - Keep It WithIn: Price Comparison</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      header {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        padding: 1.5rem 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 101;
      }

      .logo-img {
        height: 55px;
        width: auto;
        object-fit: contain;
      }

      .nav-menu {
        display: flex;
        gap: 30px;
        align-items: center;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.95rem;
      }

      .nav-item:hover {
        transform: translateY(-2px);
        opacity: 0.8;
      }

      .nav-icon {
        font-size: 1.2rem;
      }

      .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        color: white;
        font-size: 1.8rem;
        cursor: pointer;
        padding: 5px;
        z-index: 101;
      }

      @media (max-width: 968px) {
        .mobile-menu-toggle {
          display: block;
        }

        .nav-menu {
          position: fixed;
          top: 0;
          right: -100%;
          height: 100vh;
          width: 280px;
          background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
          flex-direction: column;
          padding: 80px 30px 30px;
          gap: 25px;
          transition: right 0.3s ease;
          box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
          z-index: 100;
          align-items: flex-start;
        }

        .nav-menu.active {
          right: 0;
        }

        .nav-item {
          width: 100%;
          padding: 12px 15px;
          border-radius: 10px;
          transition: all 0.3s;
          font-size: 1.1rem;
        }

        .nav-item:hover {
          background: rgba(255, 255, 255, 0.1);
          transform: translateX(5px);
        }

        .menu-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100vh;
          background: rgba(0, 0, 0, 0.5);
          z-index: 99;
        }

        .menu-overlay.active {
          display: block;
        }
      }

      @media (max-width: 480px) {
        .logo-img {
          height: 40px;
        }

        .hero h1 {
          font-size: 2rem;
        }

        .hero p {
          font-size: 1rem;
        }
      }

      .hero {
        background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
        color: white;
        padding: 80px 20px;
        text-align: center;
      }

      .hero h1 {
        font-size: 2.8rem;
        margin-bottom: 1rem;
        font-weight: 700;
      }

      .hero p {
        font-size: 1.3rem;
        opacity: 0.95;
        margin-bottom: 40px;
      }

      .search-container {
        max-width: 700px;
        margin: 0 auto;
      }

      .search-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .search-bar input {
        flex: 1;
        min-width: 250px;
        padding: 18px 25px;
        border: none;
        border-radius: 30px;
        font-size: 1.1rem;
        outline: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .search-bar button {
        background: #ffae00;
        color: white;
        border: none;
        padding: 18px 40px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(255, 174, 0, 0.3);
        white-space: nowrap;
      }

      @media (max-width: 600px) {
        .search-bar {
          flex-direction: column;
        }

        .search-bar input {
          width: 100%;
          min-width: 100%;
        }

        .search-bar button {
          width: 100%;
          padding: 16px 30px;
        }

        .hero h1 {
          font-size: 2rem;
        }

        .hero p {
          font-size: 1.1rem;
        }

        .search-hint {
          font-size: 0.85rem;
        }
      }

      .search-bar button:hover {
        background: #ff9800;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 174, 0, 0.4);
      }

      .search-bar button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .search-hint {
        color: white;
        font-size: 0.95rem;
        opacity: 0.9;
      }

      .results-section {
        padding: 50px 20px;
        min-height: 400px;
      }

      .section-title {
        text-align: center;
        font-size: 2rem;
        margin-bottom: 40px;
        color: #4caf50;
      }

      .results-grid {
        display: grid;
        gap: 25px;
      }

      .store-card {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
      }

      .store-card:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }

      .store-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .store-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: #4caf50;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .nav-menu a {
        text-decoration: none;
        color: inherit;
      }
      .store-distance {
        background: #ffae00;
        color: white;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .items-list {
        display: grid;
        gap: 12px;
        margin-bottom: 20px;
      }

      .item-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #f9f9f9;
        border-radius: 12px;
      }

      .item-name {
        font-weight: 600;
        color: #333;
        font-size: 1.05rem;
      }

      .item-price {
        font-weight: 700;
        color: #4caf50;
        font-size: 1.15rem;
      }

      .store-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-radius: 15px;
        color: black;
        border-top: 1px solid #ddd;
      }

      .total-label {
        font-size: 1.4rem;
        font-weight: 600;
      }

      .total-price {
        font-size: 1.8rem;
        font-weight: 700;
      }

      .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #999;
      }

      .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 20px;
      }

      .empty-state h3 {
        font-size: 1.5rem;
        color: #666;
        margin-bottom: 10px;
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4caf50;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      footer {
        background: #ffae00;
        color: white;
        text-align: center;
        padding: 30px 20px;
        margin-top: 50px;
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }

      .unavailable-items {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }

      .unavailable-items h3 {
        color: #856404;
        font-size: 1.2rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .unavailable-items ul {
        list-style: none;
        padding: 0;
        margin: 10px 0 0 0;
      }

      .unavailable-items li {
        color: #856404;
        padding: 6px 0;
        font-size: 1rem;
      }

      .unavailable-items li:before {
        content: "• ";
        margin-right: 8px;
      }

      .best-store-badge {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #333;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <img
              src="/Users/harry/Desktop/Kiwi-Kart-4/frontend/kiwi_cart_logo.png"
              alt="Kiwi Kart Logo"
              class="logo-img"
            />
          </div>
          <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
            ☰
          </button>
          <nav class="nav-menu" id="navMenu">
            <a href="FAQ.html">
              <div class="nav-item">
                <span class="nav-icon">❓</span>
                <span>Help</span>
              </div>
            </a>
          </nav>
        </div>
      </div>
      <div
        class="menu-overlay"
        id="menuOverlay"
        onclick="toggleMobileMenu()"
      ></div>
    </header>

    <section class="hero">
      <div class="container">
        <h1>Hello! Let's Compare Grocery Prices</h1>
        <p>Find the best deals across all stores near you</p>
        <div class="search-container">
          <div class="search-bar">
            <input
              type="text"
              placeholder="Enter items separated by comma (e.g., milk, eggs, bread)"
              id="searchInput"
            />
            <button onclick="searchPrices()" id="searchBtn">Search</button>
          </div>

          <!-- Travel & Carbon Settings -->
<div class="search-hint" style="margin-top:6px;">
  <label for="transportMode"><strong>Travel mode:</strong></label>
  <select id="transportMode">
    <option value="car" selected>Car</option>
    <option value="transit">Public Transit</option>
    <option value="motorbike">Motorbike/Scooter</option>
    <option value="rideshare">Rideshare (pooled)</option>
    <option value="walk">Walk</option>
    <option value="bike">Bike</option>
  </select>
    <div style="margin-top:8px; font-size:0.9rem; color:#e8f5e9; opacity:0.9;">
    🌿 <em>Estimates are based on average emissions per passenger-kilometre — e.g., car ≈ 0.192 kg CO₂e/km, 
    transit ≈ 0.089 kg CO₂e/km. Actual results may vary with vehicle type, traffic, and occupancy.</em>
  </div>
</div>
        </div>
      </div>
    </section>

    <section class="results-section">
      <div class="container">
        <div id="resultsContainer">
          <div class="empty-state">
            <div class="empty-state-icon">🔍</div>
            <h3>Search for grocery items to compare prices</h3>
            <p>Try searching: milk, eggs, bread</p>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <div class="container">
        <p>&copy; 2025 Kiwi Kart. All rights reserved.</p>
      </div>
    </footer>
<script>
  const API_BASE_URL = "https://elsa-hooklike-ernest.ngrok-free.dev";

  let userLocation = { lat: 49.2827, lng: -123.1207 };

  function getUserLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          userLocation.lat = position.coords.latitude;
          userLocation.lng = position.coords.longitude;
          console.log("User location updated:", userLocation);
        },
        () => {
          console.log("Using default location (Vancouver):", userLocation);
        }
      );
    }
  }
  getUserLocation();

  // ---------- CARBON HELPERS (single source) ----------
  const EMISSION_FACTORS = {
    car: 0.192,       // kg CO2e per passenger-km
    motorbike: 0.103,
    rideshare: 0.096, // pooled (~2 pax)
    transit: 0.089,
    walk: 0.0,
    bike: 0.0
  };
const MODE_NOTE = {
  car: "an average car",
  motorbike: "an average motorbike/scooter",
  rideshare: "a pooled rideshare (avg.)",
  transit: "average public transit",
  walk: "walking (no direct tailpipe emissions)",
  bike: "cycling (no direct tailpipe emissions)"
};

  function getTransportMode() {
    return document.getElementById('transportMode')?.value || 'car';
  }

  // Haversine distance in km (fallback if API doesn't give distance_km)
  function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371, toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
  }

  function computeRoundTripKgCO2e(oneWayKm, mode) {
    const ef = EMISSION_FACTORS[mode] ?? EMISSION_FACTORS.car;
    return (oneWayKm * 2) * ef;
  }

  const fmtKg = v => `${v.toFixed(2)} kg`;
  const fmtMoney = v => `$${Number(v).toFixed(2)}`;

  // ---------- FALLBACK SEARCH (unchanged except cleaned) ----------
  async function searchItemsIndividually(items, resultsContainer) {
    console.log("Searching items individually...");
    const availableItems = [];
    const unavailableItems = [];
    const allPrices = [];
    const allStores = new Map();

    for (const item of items) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/v1/summary`, {
          method: "POST",
          headers: { "Content-Type": "application/json", Accept: "application/json" },
          mode: "cors",
          body: JSON.stringify({
            items: [item],
            user_lat: userLocation.lat,
            user_lng: userLocation.lng,
            radius_km: 50,
          }),
        });

        if (response.ok) {
          const data = await response.json();
          if (data.items && data.items.length > 0) {
            availableItems.push(...data.items);
            if (data.prices) allPrices.push(...data.prices);
            if (data.stores) data.stores.forEach((s) => allStores.set(s.id, s));
          } else {
            unavailableItems.push(item);
          }
        } else {
          unavailableItems.push(item);
        }
      } catch {
        unavailableItems.push(item);
      }
    }

    if (availableItems.length === 0) {
      resultsContainer.innerHTML = `
        <div class="error-message">🚫 Products Not Available</div>
        <div class="unavailable-items">
          <h3>❌ None of these items are for sale</h3>
          <p>The following items are not available in any nearby stores:</p>
          <ul>${items.map((item) => `<li><strong>${item}</strong></li>`).join("")}</ul>
          <p style="margin-top: 15px; color: #856404;">💡 Please try searching for different items.</p>
        </div>
      `;
    } else {
      const combinedData = {
        items: availableItems,
        prices: allPrices,
        stores: Array.from(allStores.values()),
        single_store_totals: calculateStoreTotals(allPrices),
        best_single_store: null,
      };
      displayResults(combinedData, items);
    }
  }

  function calculateStoreTotals(prices) {
    const storeTotals = new Map();
    prices.forEach((p) => {
      const current = storeTotals.get(p.store_id) || 0;
      storeTotals.set(p.store_id, current + p.price);
    });
    return Array.from(storeTotals.entries()).map(([store_id, total]) => ({ store_id, total }));
  }

  // ---------- MAIN SEARCH ----------
  async function searchPrices() {
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const resultsContainer = document.getElementById("resultsContainer");

    const inputText = searchInput.value.trim();
    if (!inputText) { alert("Please enter at least one item to search"); return; }

    const items = inputText.split(",").map((i) => i.trim()).filter(Boolean);
    if (items.length === 0) { alert("Please enter valid items separated by commas"); return; }

    resultsContainer.innerHTML = `
      <div class="loading">
        <div class="loading-spinner"></div>
        <p style="color: #666; font-size: 1.1rem;">Searching for best prices...</p>
      </div>
    `;

    searchBtn.disabled = true;
    searchBtn.textContent = "Searching...";

    try {
      const requestBody = {
        items,
        user_lat: userLocation.lat,
        user_lng: userLocation.lng,
        radius_km: 50,
      };

      const response = await fetch(`${API_BASE_URL}/api/v1/summary`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Accept: "application/json" },
        mode: "cors",
        body: JSON.stringify(requestBody),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        if (errorData.detail && typeof errorData.detail === "string") {
          if (
            errorData.detail.includes("Missing price for") ||
            errorData.detail.includes("not found") ||
            errorData.detail.includes("not available")
          ) {
            await searchItemsIndividually(items, resultsContainer);
            return;
          } else if (errorData.detail.includes("No stores within the radius")) {
            throw new Error("NO_STORES_FOUND");
          }
        }
        throw new Error(`API_ERROR:${errorData.detail || response.statusText}`);
      }

      const data = await response.json();
      displayResults(data, items);
    } catch (error) {
      console.error("Error fetching prices:", error);
      if (error.message === "NO_STORES_FOUND") {
        resultsContainer.innerHTML = `
          <div class="error-message">📍 No stores found within 50km radius</div>
          <div class="empty-state">
            <div class="empty-state-icon">🏪</div>
            <h3>No nearby stores</h3>
            <p>Try expanding your search radius or check your location settings</p>
          </div>
        `;
      } else if (error.message.startsWith("API_ERROR:")) {
        const apiErrorMsg = error.message.split(":")[1];
        resultsContainer.innerHTML = `
          <div class="error-message">⚠️ API Error: ${apiErrorMsg}</div>
          <div class="empty-state">
            <div class="empty-state-icon">😕</div>
            <h3>Unable to fetch prices</h3>
            <p>Please try again or contact support</p>
          </div>
        `;
      } else if (error.message.includes("Failed to fetch")) {
        resultsContainer.innerHTML = `
          <div class="error-message">⚠️ Cannot connect to the server
            <p style="margin-top: 10px; font-size: 0.95rem;">
              Please check:<br>
              • Backend running?<br>
              • ngrok active?<br>
              • CORS enabled?<br>
              • Current API URL: ${API_BASE_URL}
            </p>
          </div>
          <div class="empty-state">
            <div class="empty-state-icon">😕</div>
            <h3>Unable to fetch prices</h3>
            <p>Check the browser console for more details</p>
          </div>
        `;
      } else {
        resultsContainer.innerHTML = `
          <div class="error-message">⚠️ ${error.message}</div>
          <div class="empty-state">
            <div class="empty-state-icon">😕</div>
            <h3>Something went wrong</h3>
            <p>Please try again or check the console for details</p>
          </div>
        `;
      }
    } finally {
      searchBtn.disabled = false;
      searchBtn.textContent = "Search";
    }
  }

  // ---------- RENDER RESULTS (with CO₂) ----------
  let _lastDataForCarbon = null;
  let _lastItemsForCarbon = null;

  function displayResults(data, searchedItems) {
    _lastDataForCarbon = data;
    _lastItemsForCarbon = searchedItems;

    const resultsContainer = document.getElementById("resultsContainer");

    if (!data || !data.single_store_totals || data.single_store_totals.length === 0) {
      if (data && data.items && data.items.length === 0) {
        resultsContainer.innerHTML = `
          <div class="error-message">🚫 Products Not Available</div>
          <div class="unavailable-items">
            <h3>❌ None of these items are for sale</h3>
            <p>The following items are not available in any nearby stores:</p>
            <ul>${searchedItems.map((i) => `<li><strong>${i}</strong></li>`).join("")}</ul>
            <p style="margin-top: 15px; color: #856404;">💡 Please try searching for different items.</p>
          </div>
        `;
      } else {
        resultsContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">😕</div>
            <h3>No results found</h3>
            <p>Try searching for different items or expand your search radius</p>
          </div>
        `;
      }
      return;
    }

    const normalizedSearchedItems = searchedItems.map((i) => i.toLowerCase().trim());
    const normalizedDataItems = (data.items || []).map((i) => i.toLowerCase().trim());
    const unavailableItems = searchedItems.filter((_, idx) => !normalizedDataItems.includes(normalizedSearchedItems[idx]));

    const storeMap = {};
    if (Array.isArray(data.stores)) data.stores.forEach((s) => { storeMap[s.id] = s; });

    const mode = getTransportMode();

    // Prepare store results with distance and maps link
    const storeResults = data.single_store_totals
      .map((storeTotal) => {
        const storeInfo = storeMap[storeTotal.store_id] || {};
        const storeItems = (data.prices || [])
          .filter((p) => p.store_id === storeTotal.store_id)
          .map((p) => ({ name: p.item, price: p.price.toFixed(2), unit: p.unit }));

        // Calculate one-way distance (prefer API, else haversine)
        let oneWayKm = null;
        if (typeof storeInfo.distance_km === 'number') {
          oneWayKm = storeInfo.distance_km;
        } else if (storeInfo.lat && storeInfo.lng && userLocation?.lat && userLocation?.lng) {
          oneWayKm = distanceKm(userLocation.lat, userLocation.lng, storeInfo.lat, storeInfo.lng);
        }

        let co2Kg = null;
        if (oneWayKm != null) co2Kg = computeRoundTripKgCO2e(oneWayKm, mode);

        const isBestStore =
          data.best_single_store && data.best_single_store.store_id === storeTotal.store_id;

        // --- FIX: Use storeInfo.address for Google Maps if available and valid ---
        let mapsLink = "";
        if (
          storeInfo.lat !== undefined &&
          storeInfo.lng !== undefined &&
          !isNaN(Number(storeInfo.lat)) &&
          !isNaN(Number(storeInfo.lng))
        ) {
          // If coordinates are valid, use them
          mapsLink = `https://www.google.com/maps/search/?api=1&query=${storeInfo.lat},${storeInfo.lng}`;
        } else if (storeInfo.address && typeof storeInfo.address === "string" && storeInfo.address.trim().length > 0) {
          // If address is available, use it for better accuracy
          mapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(storeInfo.address)}`;
        } else {
          // Fallback to store name
          const storeName = encodeURIComponent(storeInfo.name || storeTotal.store_id);
          mapsLink = `https://www.google.com/maps/search/?api=1&query=${storeName}`;
        }
        // --- END FIX ---

        return {
          store_id: storeTotal.store_id,
          store_name: storeInfo.name || storeTotal.store_id,
          distance_km: oneWayKm,
          distance_label: (typeof oneWayKm === 'number') ? `${oneWayKm.toFixed(1)} km one-way` : "N/A",
          items: storeItems,
          total: storeTotal.total.toFixed(2),
          is_best: isBestStore,
          co2Kg,
          mapsLink
        };
      });

  // --- NEW: Find the closest store by distance ---
  let closestStore = null;
  let minDistance = Infinity;
  for (const store of storeResults) {
    if (typeof store.distance_km === "number" && store.distance_km < minDistance) {
      minDistance = store.distance_km;
      closestStore = store;
    }
  }
  // --- END NEW ---

  // Sort by total price as before
  storeResults.sort((a, b) => parseFloat(a.total) - parseFloat(b.total));

  let html = "";

  if (unavailableItems.length > 0) {
    html += `
      <div class="unavailable-items">
        <h3>🚫 Items Not For Sale</h3>
        <p>The following ${unavailableItems.length === 1 ? "item is" : "items are"} not currently available in any nearby stores:</p>
        <ul>${unavailableItems.map((i) => `<li><strong>${i}</strong> - Not available for purchase</li>`).join("")}</ul>
        <p style="margin-top: 12px; font-size: 0.95rem; color: #856404;">
          💡 <strong>Tip:</strong> Try searching for similar items or check back later.
        </p>
      </div>
    `;
  }

  html += `
    <h2 class="section-title">Top 3 Cheapest Stores</h2>
    ${
      closestStore
        ? `<div style="text-align:center;margin-bottom:30px;">
            <span style="font-size:1.1rem;font-weight:600;color:#1976d2;">
              🥇 Closest Store: ${closestStore.store_name} (${closestStore.distance_label})
            </span>
            <a href="${closestStore.mapsLink}" 
               target="_blank" 
               rel="noopener noreferrer"
               style="display:inline-block;margin-left:12px;color:#1976d2;font-weight:600;text-decoration:underline;">
              📍 View on Google Maps
            </a>
          </div>`
        : ""
    } 
    <div class="results-grid"> 
      ${storeResults.slice(0, 3).map((store) => `
        <div class="store-card">
          <div class="store-header">
            <div class="store-name">
              <span>🏪</span>
              ${store.store_name}
              ${store.is_best ? '<span class="best-store-badge">🏆 Best Deal</span>' : ''}
            </div>
            <div class="store-distance">📍 ${store.distance_label}</div>
          </div>

          <div class="items-list">
            ${store.items.map((item) => `
              <div class="item-row">
                <span class="item-name">${item.name} ${item.unit ? `(${item.unit})` : ""}</span>
                <span class="item-price">$${item.price}</span>
              </div>
            `).join("")}
          </div>

          <div class="store-total">
            <span class="total-label">Total Price</span>
            <div style="text-align:right">
              <div class="total-price">${fmtMoney(store.total)}</div>
              <div style="margin-top:6px; font-size:0.95rem; color:#2e7d32; font-weight:600;">
                🌿 Est. travel (round trip, ${mode}):
                ${store.co2Kg != null ? fmtKg(store.co2Kg) : '—'} CO₂e
                <span style="display:block; font-size:0.85rem; color:#388e3c; font-weight:400;">
                  Based on ${MODE_NOTE[mode] || 'average transport'} emissions
                </span>
              </div>
            </div>
          </div>
          <div style="margin-top: 15px;">
            <a href="${store.mapsLink}" 
               target="_blank" 
               rel="noopener noreferrer"
               style="color: #1976d2; font-weight: 600; text-decoration: underline; font-size: 1rem;">
              📍 View this store on Google Maps
            </a>
          </div>
        </div>
      `).join("")}
    </div>
  `;

  resultsContainer.innerHTML = html;
}

// Re-render CO₂ when transport mode changes
document.getElementById('transportMode')?.addEventListener('change', () => {
  if (_lastDataForCarbon && _lastItemsForCarbon) {
    displayResults(_lastDataForCarbon, _lastItemsForCarbon);
  }
});

// Enter key to search
document.getElementById("searchInput").addEventListener("keyup", (e) => {
  if (e.key === "Enter") searchPrices();
});

function toggleMobileMenu() {
  const navMenu = document.getElementById("navMenu");
  const menuOverlay = document.getElementById("menuOverlay");
  const menuToggle = document.querySelector(".mobile-menu-toggle");

  navMenu.classList.toggle("active");
  menuOverlay.classList.toggle("active");

  menuToggle.textContent = navMenu.classList.contains("active") ? "✕" : "☰";
}
</script>

  </body>
</html>

