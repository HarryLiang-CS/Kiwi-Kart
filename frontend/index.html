<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kiwi Kart - Price Comparison</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      header {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        padding: 1.5rem 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 101;
      }

      .logo-img {
        height: 55px;
        width: auto;
        object-fit: contain;
      }

      .nav-menu {
        display: flex;
        gap: 30px;
        align-items: center;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.95rem;
      }

      .nav-item:hover {
        transform: translateY(-2px);
        opacity: 0.8;
      }

      .nav-icon {
        font-size: 1.2rem;
      }

      .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        color: white;
        font-size: 1.8rem;
        cursor: pointer;
        padding: 5px;
        z-index: 101;
      }

      @media (max-width: 968px) {
        .mobile-menu-toggle {
          display: block;
        }

        .nav-menu {
          position: fixed;
          top: 0;
          right: -100%;
          height: 100vh;
          width: 280px;
          background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
          flex-direction: column;
          padding: 80px 30px 30px;
          gap: 25px;
          transition: right 0.3s ease;
          box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
          z-index: 100;
          align-items: flex-start;
        }

        .nav-menu.active {
          right: 0;
        }

        .nav-item {
          width: 100%;
          padding: 12px 15px;
          border-radius: 10px;
          transition: all 0.3s;
          font-size: 1.1rem;
        }

        .nav-item:hover {
          background: rgba(255, 255, 255, 0.1);
          transform: translateX(5px);
        }

        .menu-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100vh;
          background: rgba(0, 0, 0, 0.5);
          z-index: 99;
        }

        .menu-overlay.active {
          display: block;
        }
      }

      @media (max-width: 480px) {
        .logo-img {
          height: 40px;
        }

        .hero h1 {
          font-size: 2rem;
        }

        .hero p {
          font-size: 1rem;
        }
      }

      .hero {
        background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
        color: white;
        padding: 80px 20px;
        text-align: center;
      }

      .hero h1 {
        font-size: 2.8rem;
        margin-bottom: 1rem;
        font-weight: 700;
      }

      .hero p {
        font-size: 1.3rem;
        opacity: 0.95;
        margin-bottom: 40px;
      }

      .search-container {
        max-width: 700px;
        margin: 0 auto;
      }

      .search-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .search-bar input {
        flex: 1;
        min-width: 250px;
        padding: 18px 25px;
        border: none;
        border-radius: 30px;
        font-size: 1.1rem;
        outline: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .search-bar button {
        background: #ffae00;
        color: white;
        border: none;
        padding: 18px 40px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(255, 174, 0, 0.3);
        white-space: nowrap;
      }

      @media (max-width: 600px) {
        .search-bar {
          flex-direction: column;
        }

        .search-bar input {
          width: 100%;
          min-width: 100%;
        }

        .search-bar button {
          width: 100%;
          padding: 16px 30px;
        }

        .hero h1 {
          font-size: 2rem;
        }

        .hero p {
          font-size: 1.1rem;
        }

        .search-hint {
          font-size: 0.85rem;
        }
      }

      .search-bar button:hover {
        background: #ff9800;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 174, 0, 0.4);
      }

      .search-bar button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .search-hint {
        color: white;
        font-size: 0.95rem;
        opacity: 0.9;
      }

      .results-section {
        padding: 50px 20px;
        min-height: 400px;
      }

      .section-title {
        text-align: center;
        font-size: 2rem;
        margin-bottom: 40px;
        color: #4caf50;
      }

      .results-grid {
        display: grid;
        gap: 25px;
      }

      .store-card {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
      }

      .store-card:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }

      .store-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .store-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: #4caf50;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .nav-menu a {
        text-decoration: none;
        color: inherit;
      }
      .store-distance {
        background: #ffae00;
        color: white;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .items-list {
        display: grid;
        gap: 12px;
        margin-bottom: 20px;
      }

      .item-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #f9f9f9;
        border-radius: 12px;
      }

      .item-name {
        font-weight: 600;
        color: #333;
        font-size: 1.05rem;
      }

      .item-price {
        font-weight: 700;
        color: #4caf50;
        font-size: 1.15rem;
      }

      .store-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-radius: 15px;
        color: black;
        border-top: 1px solid #ddd;
      }

      .total-label {
        font-size: 1.4rem;
        font-weight: 600;
      }

      .total-price {
        font-size: 1.8rem;
        font-weight: 700;
      }

      .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #999;
      }

      .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 20px;
      }

      .empty-state h3 {
        font-size: 1.5rem;
        color: #666;
        margin-bottom: 10px;
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4caf50;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      footer {
        background: #ffae00;
        color: white;
        text-align: center;
        padding: 30px 20px;
        margin-top: 50px;
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }

      .unavailable-items {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }

      .unavailable-items h3 {
        color: #856404;
        font-size: 1.2rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .unavailable-items ul {
        list-style: none;
        padding: 0;
        margin: 10px 0 0 0;
      }

      .unavailable-items li {
        color: #856404;
        padding: 6px 0;
        font-size: 1rem;
      }

      .unavailable-items li:before {
        content: "• ";
        margin-right: 8px;
      }

      .best-store-badge {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #333;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <img
              src="/Users/harry/Desktop/Kiwi-Kart-4/frontend/kiwi_cart_logo.png"
              alt="Kiwi Kart Logo"
              class="logo-img"
            />
          </div>
          <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
            ☰
          </button>
          <nav class="nav-menu" id="navMenu">
            <a href="FAQ.html">
              <div class="nav-item">
                <span class="nav-icon">❓</span>
                <span>Help</span>
              </div>
            </a>
          </nav>
        </div>
      </div>
      <div
        class="menu-overlay"
        id="menuOverlay"
        onclick="toggleMobileMenu()"
      ></div>
    </header>

    <section class="hero">
      <div class="container">
        <h1>Compare Grocery Prices</h1>
        <p>Find the best deals across all stores near you</p>
        <div class="search-container">
          <div class="search-bar">
            <input
              type="text"
              placeholder="Enter items separated by comma (e.g., milk, eggs, bread)"
              id="searchInput"
            />
             <input
               id="radius_km"
               type="number"
               value="5"
               min="0.1"
               max="50"
               step="0.1"
               style="padding: 18px 20px; border: none; border-radius: 30px;
           box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 120px;"
  />
  <span style="color:white;">km radius</span>
            <button onclick="searchPrices()" id="searchBtn">Search</button>
          </div>
        </div>
      </div>
    </section>

    <section class="results-section">
      <div class="container">
        <div id="resultsContainer">
          <div class="empty-state">
            <div class="empty-state-icon">🔍</div>
            <h3>Search for grocery items to compare prices</h3>
            <p>Try searching: milk, eggs, bread</p>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <div class="container">
        <p>&copy; 2025 Kiwi Kart. All rights reserved.</p>
      </div>
    </footer>

    <script>
      const API_BASE_URL = "https://elsa-hooklike-ernest.ngrok-free.dev";

      let userLocation = {
        lat: 49.2827,
        lng: -123.1207,
      };

      function getUserLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation.lat = position.coords.latitude;
              userLocation.lng = position.coords.longitude;
              console.log("User location updated:", userLocation);
            },
            (error) => {
              console.log("Using default location (Vancouver):", userLocation);
            }
          );
        }
      }

      getUserLocation();

      // Helper function to search items individually when backend returns error
      async function searchItemsIndividually(items, resultsContainer) {
        console.log("Searching items individually...");
        const availableItems = [];
        const unavailableItems = [];
        const allPrices = [];
        const allStores = new Map();

        for (const item of items) {
          try {
            console.log(`Searching for: ${item}`);
            const response = await fetch(`${API_BASE_URL}/api/v1/summary`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              mode: "cors",
              body: JSON.stringify({
                items: [item],
                user_lat: userLocation.lat,
                user_lng: userLocation.lng,
                radius_km: radiusKm,
              }),
            });

            if (response.ok) {
              const data = await response.json();
              if (data.items && data.items.length > 0) {
                console.log(`✓ Found: ${item}`);
                availableItems.push(...data.items);
                if (data.prices) {
                  allPrices.push(...data.prices);
                }
                if (data.stores) {
                  data.stores.forEach((store) => {
                    allStores.set(store.id, store);
                  });
                }
              } else {
                console.log(`✗ Not found: ${item}`);
                unavailableItems.push(item);
              }
            } else {
              console.log(`✗ Error for: ${item}`);
              unavailableItems.push(item);
            }
          } catch (err) {
            console.log(`✗ Exception for "${item}":`, err);
            unavailableItems.push(item);
          }
        }

        console.log("Available:", availableItems);
        console.log("Unavailable:", unavailableItems);

        if (availableItems.length === 0) {
          resultsContainer.innerHTML = `
            <div class="error-message">
              🚫 Products Not Available
            </div>
            <div class="unavailable-items">
              <h3>❌ None of these items are for sale</h3>
              <p>The following items are not available in any nearby stores:</p>
              <ul>
                ${items
                  .map((item) => `<li><strong>${item}</strong></li>`)
                  .join("")}
              </ul>
              <p style="margin-top: 15px; color: #856404;">
                💡 Please try searching for different items.
              </p>
            </div>
          `;
        } else {
          const combinedData = {
            items: availableItems,
            prices: allPrices,
            stores: Array.from(allStores.values()),
            single_store_totals: calculateStoreTotals(allPrices),
            best_single_store: null,
          };

          displayResults(combinedData, items);
        }
      }

      function calculateStoreTotals(prices) {
        const storeTotals = new Map();

        prices.forEach((price) => {
          const current = storeTotals.get(price.store_id) || 0;
          storeTotals.set(price.store_id, current + price.price);
        });

        return Array.from(storeTotals.entries()).map(([store_id, total]) => ({
          store_id,
          total,
        }));
      }

      async function searchPrices() {
        const searchInput = document.getElementById("searchInput");
        const radiusInput = document.getElementById("radius_km");
        const radiusKm = radiusInput.value === "" ? 5 : Number(radiusInput.value);
        const searchBtn = document.getElementById("searchBtn");
        const resultsContainer = document.getElementById("resultsContainer");

        const inputText = searchInput.value.trim();

        if (!inputText) {
          alert("Please enter at least one item to search");
          return;
        }

        const items = inputText
          .split(",")
          .map((item) => item.trim())
          .filter((item) => item.length > 0);

        if (items.length === 0) {
          alert("Please enter valid items separated by commas");
          return;
        }

        resultsContainer.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <p style="color: #666; font-size: 1.1rem;">Searching for best prices...</p>
          </div>
        `;

        searchBtn.disabled = true;
        searchBtn.textContent = "Searching...";

        try {
          const requestBody = {
            items: items,
            user_lat: userLocation.lat,
            user_lng: userLocation.lng,
            radius_km: radiusKm,
          };

          console.log("API URL:", `${API_BASE_URL}/api/v1/summary`);
          console.log("Sending request:", requestBody);

          const response = await fetch(`${API_BASE_URL}/api/v1/summary`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            mode: "cors",
            body: JSON.stringify(requestBody),
          });

          console.log("Response status:", response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error("API error response:", errorData);

            if (errorData.detail && typeof errorData.detail === "string") {
              // If backend returns error for missing items, search individually
              if (
                errorData.detail.includes("Missing price for") ||
                errorData.detail.includes("not found") ||
                errorData.detail.includes("not available")
              ) {
                console.log(
                  "Backend doesn't support partial results. Searching individually..."
                );
                await searchItemsIndividually(items, resultsContainer);
                searchBtn.disabled = false;
                searchBtn.textContent = "Search";
                return;
              } else if (
                errorData.detail.includes("No stores within the radius")
              ) {
                throw new Error("NO_STORES_FOUND");
              }
            }

            throw new Error(
              `API_ERROR:${errorData.detail || response.statusText}`
            );
          }

          const data = await response.json();
          console.log("Received data:", data);

          displayResults(data, items);
        } catch (error) {
          console.error("Error fetching prices:", error);

          let errorMsg = error.message;
          let errorDetails = "";

          if (error.message === "NO_STORES_FOUND") {
            resultsContainer.innerHTML = `
              <div class="error-message">
                📍 No stores found within ${radiusKm}km radius
              </div>
              <div class="empty-state">
                <div class="empty-state-icon">🏪</div>
                <h3>No nearby stores</h3>
                <p>Try expanding your search radius or check your location settings</p>
              </div>
            `;
          } else if (error.message.startsWith("API_ERROR:")) {
            const apiErrorMsg = error.message.split(":")[1];
            resultsContainer.innerHTML = `
              <div class="error-message">
                ⚠️ API Error: ${apiErrorMsg}
              </div>
              <div class="empty-state">
                <div class="empty-state-icon">😕</div>
                <h3>Unable to fetch prices</h3>
                <p>Please try again or contact support</p>
              </div>
            `;
          } else if (error.message.includes("Failed to fetch")) {
            errorMsg = "Cannot connect to the server";
            errorDetails = `
              <p style="margin-top: 10px; font-size: 0.95rem;">
                Please check:<br>
                • Is your backend server running?<br>
                • Is ngrok tunnel active?<br>
                • Is CORS enabled on your backend?<br>
                • Current API URL: ${API_BASE_URL}
              </p>
            `;
            resultsContainer.innerHTML = `
              <div class="error-message">
                ⚠️ ${errorMsg}
                ${errorDetails}
              </div>
              <div class="empty-state">
                <div class="empty-state-icon">😕</div>
                <h3>Unable to fetch prices</h3>
                <p>Check the browser console for more details</p>
              </div>
            `;
          } else {
            resultsContainer.innerHTML = `
              <div class="error-message">
                ⚠️ ${errorMsg}
              </div>
              <div class="empty-state">
                <div class="empty-state-icon">😕</div>
                <h3>Something went wrong</h3>
                <p>Please try again or check the console for details</p>
              </div>
            `;
          }
        } finally {
          searchBtn.disabled = false;
          searchBtn.textContent = "Search";
        }
      }

      function displayResults(data, searchedItems) {
        const resultsContainer = document.getElementById("resultsContainer");

        if (
          !data ||
          !data.single_store_totals ||
          data.single_store_totals.length === 0
        ) {
          if (data && data.items && data.items.length === 0) {
            resultsContainer.innerHTML = `
              <div class="error-message">
                🚫 Products Not Available
              </div>
              <div class="unavailable-items">
                <h3>❌ None of these items are for sale</h3>
                <p>The following items are not available in any nearby stores:</p>
                <ul>
                  ${searchedItems
                    .map((item) => `<li><strong>${item}</strong></li>`)
                    .join("")}
                </ul>
                <p style="margin-top: 15px; color: #856404;">
                  💡 Please try searching for different items.
                </p>
              </div>
            `;
          } else {
            resultsContainer.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">😕</div>
                <h3>No results found</h3>
                <p>Try searching for different items or expand your search radius</p>
              </div>
            `;
          }
          return;
        }

        const normalizedSearchedItems = searchedItems.map((item) =>
          item.toLowerCase().trim()
        );
        const normalizedDataItems = data.items.map((item) =>
          item.toLowerCase().trim()
        );

        const unavailableItems = searchedItems.filter(
          (item, index) =>
            !normalizedDataItems.includes(normalizedSearchedItems[index])
        );

        const storeMap = {};
        if (data.stores && Array.isArray(data.stores)) {
          data.stores.forEach((store) => {
            storeMap[store.id] = store;
          });
        }

        const storeResults = data.single_store_totals
          .map((storeTotal) => {
            const storeInfo = storeMap[storeTotal.store_id] || {};
            const storeItems = data.prices
              .filter((price) => price.store_id === storeTotal.store_id)
              .map((price) => ({
                name: price.item,
                price: price.price.toFixed(2),
                unit: price.unit,
              }));

            const isBestStore =
              data.best_single_store &&
              data.best_single_store.store_id === storeTotal.store_id;

            return {
              store_id: storeTotal.store_id,
              store_name: storeInfo.name || storeTotal.store_id,
              distance: storeInfo.distance_km
                ? storeInfo.distance_km.toFixed(1)
                : "N/A",
              items: storeItems,
              total: storeTotal.total.toFixed(2),
              is_best: isBestStore,
            };
          })
          .sort((a, b) => parseFloat(a.total) - parseFloat(b.total)).slice(0,3);

        let html = "";

        if (unavailableItems.length > 0) {
          html += `
            <div class="unavailable-items">
              <h3>🚫 Items Not For Sale</h3>
              <p>The following ${
                unavailableItems.length === 1 ? "item is" : "items are"
              } not currently available in any nearby stores:</p>
              <ul>
                ${unavailableItems
                  .map(
                    (item) =>
                      `<li><strong>${item}</strong> - Not available for purchase</li>`
                  )
                  .join("")}
              </ul>
              <p style="margin-top: 12px; font-size: 0.95rem; color: #856404;">
                💡 <strong>Tip:</strong> Try searching for similar items or check back later.
              </p>
            </div>
          `;
        }

        html += `
          <h2 class="section-title">Top 3 Cheapest Stores</h2>
          <div class="results-grid">
            ${storeResults
              .map(
                (store) => `
              <div class="store-card">
                <div class="store-header">
                  <div class="store-name">
                    <span>🏪</span>
                    ${store.store_name}
                    ${
                      store.is_best
                        ? '<span class="best-store-badge">🏆 Best Deal</span>'
                        : ""
                    }
                  </div>
                  <div class="store-distance">📍 ${store.distance} km</div>
                </div>
                <div class="items-list">
                  ${store.items
                    .map(
                      (item) => `
                    <div class="item-row">
                      <span class="item-name">${item.name} ${
                        item.unit ? `(${item.unit})` : ""
                      }</span>
                      <span class="item-price">$${item.price}</span>
                    </div>
                  `
                    )
                    .join("")}
                </div>
                <div class="store-total">
                  <span class="total-label">Total Price</span>
                  <span class="total-price">$${store.total}</span>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;

        resultsContainer.innerHTML = html;
      }

      document.getElementById("searchInput").addEventListener("keyup", (e) => {
        if (e.key === "Enter") searchPrices();
      });

      function toggleMobileMenu() {
        const navMenu = document.getElementById("navMenu");
        const menuOverlay = document.getElementById("menuOverlay");
        const menuToggle = document.querySelector(".mobile-menu-toggle");

        navMenu.classList.toggle("active");
        menuOverlay.classList.toggle("active");

        if (navMenu.classList.contains("active")) {
          menuToggle.textContent = "✕";
        } else {
          menuToggle.textContent = "☰";
        }
      }
    </script>
  </body>
</html>
