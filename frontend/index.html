<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kiwi Kart - Price Comparison</title>
    <link rel="stylesheet" href="/frontend/css/style.css" />
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <img
              src="/image/kiwi_cart_logo.png"
              alt="Kiwi Kart Logo"
              class="logo-img"
            />
          </div>
          <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
            ‚ò∞
          </button>
          <nav class="nav-menu" id="navMenu">
            <a href="FAQ.html">
              <div class="nav-item">
                <span class="nav-icon">‚ùì</span>
                <span>Help</span>
              </div>
            </a>
          </nav>
        </div>
      </div>
      <div
        class="menu-overlay"
        id="menuOverlay"
        onclick="toggleMobileMenu()"
      ></div>
    </header>

    <section class="hero">
      <div class="container">
        <h1>Compare Grocery Prices</h1>
        <p>Find the best deals across all stores near you</p>
        <div class="search-container">
          <div class="search-bar">
            <input
              type="text"
              placeholder="Enter items separated by comma (e.g., milk, eggs, bread)"
              id="searchInput"
            />
            <button onclick="searchPrices()" id="searchBtn">Search</button>
          </div>
        </div>
      </div>
    </section>

    <section class="results-section">
      <div class="container">
        <div id="resultsContainer">
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h3>Search for grocery items to compare prices</h3>
            <p>Try searching: milk, eggs, bread</p>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <div class="container">
        <p>&copy; 2025 Kiwi Kart. All rights reserved.</p>
      </div>
    </footer>

    <script>
      const API_BASE_URL = "https://elsa-hooklike-ernest.ngrok-free.dev";

      let userLocation = {
        lat: 49.2827,
        lng: -123.1207,
      };

      function getUserLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation.lat = position.coords.latitude;
              userLocation.lng = position.coords.longitude;
              console.log("User location updated:", userLocation);
            },
            (error) => {
              console.log("Using default location (Vancouver):", userLocation);
            }
          );
        }
      }

      getUserLocation();

      // Helper function to search items individually when backend returns error
      async function searchItemsIndividually(items, resultsContainer) {
        console.log("Searching items individually...");
        const availableItems = [];
        const unavailableItems = [];
        const allPrices = [];
        const allStores = new Map();

        for (const item of items) {
          try {
            console.log(`Searching for: ${item}`);
            const response = await fetch(`${API_BASE_URL}/api/v1/summary`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              mode: "cors",
              body: JSON.stringify({
                items: [item],
                user_lat: userLocation.lat,
                user_lng: userLocation.lng,
                radius_km: 50,
              }),
            });

            if (response.ok) {
              const data = await response.json();
              if (data.items && data.items.length > 0) {
                console.log(`‚úì Found: ${item}`);
                availableItems.push(...data.items);
                if (data.prices) {
                  allPrices.push(...data.prices);
                }
                if (data.stores) {
                  data.stores.forEach((store) => {
                    allStores.set(store.id, store);
                  });
                }
              } else {
                console.log(`‚úó Not found: ${item}`);
                unavailableItems.push(item);
              }
            } else {
              console.log(`‚úó Error for: ${item}`);
              unavailableItems.push(item);
            }
          } catch (err) {
            console.log(`‚úó Exception for "${item}":`, err);
            unavailableItems.push(item);
          }
        }

        console.log("Available:", availableItems);
        console.log("Unavailable:", unavailableItems);

        if (availableItems.length === 0) {
          resultsContainer.innerHTML = `
            <div class="error-message">
              üö´ Products Not Available
            </div>
            <div class="unavailable-items">
              <h3>‚ùå None of these items are for sale</h3>
              <p>The following items are not available in any nearby stores:</p>
              <ul>
                ${items
                  .map((item) => `<li><strong>${item}</strong></li>`)
                  .join("")}
              </ul>
              <p style="margin-top: 15px; color: #856404;">
                üí° Please try searching for different items.
              </p>
            </div>
          `;
        } else {
          const combinedData = {
            items: availableItems,
            prices: allPrices,
            stores: Array.from(allStores.values()),
            single_store_totals: calculateStoreTotals(allPrices),
            best_single_store: null,
          };

          displayResults(combinedData, items);
        }
      }

      function calculateStoreTotals(prices) {
        const storeTotals = new Map();

        prices.forEach((price) => {
          const current = storeTotals.get(price.store_id) || 0;
          storeTotals.set(price.store_id, current + price.price);
        });

        return Array.from(storeTotals.entries()).map(([store_id, total]) => ({
          store_id,
          total,
        }));
      }

      async function searchPrices() {
        const searchInput = document.getElementById("searchInput");
        const searchBtn = document.getElementById("searchBtn");
        const resultsContainer = document.getElementById("resultsContainer");

        const inputText = searchInput.value.trim();

        if (!inputText) {
          alert("Please enter at least one item to search");
          return;
        }

        const items = inputText
          .split(",")
          .map((item) => item.trim())
          .filter((item) => item.length > 0);

        if (items.length === 0) {
          alert("Please enter valid items separated by commas");
          return;
        }

        resultsContainer.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <p style="color: #666; font-size: 1.1rem;">Searching for best prices...</p>
          </div>
        `;

        searchBtn.disabled = true;
        searchBtn.textContent = "Searching...";

        try {
          const requestBody = {
            items: items,
            user_lat: userLocation.lat,
            user_lng: userLocation.lng,
            radius_km: 50,
          };

          console.log("API URL:", `${API_BASE_URL}/api/v1/summary`);
          console.log("Sending request:", requestBody);

          const response = await fetch(`${API_BASE_URL}/api/v1/summary`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            mode: "cors",
            body: JSON.stringify(requestBody),
          });

          console.log("Response status:", response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error("API error response:", errorData);

            if (errorData.detail && typeof errorData.detail === "string") {
              // If backend returns error for missing items, search individually
              if (
                errorData.detail.includes("Missing price for") ||
                errorData.detail.includes("not found") ||
                errorData.detail.includes("not available")
              ) {
                console.log(
                  "Backend doesn't support partial results. Searching individually..."
                );
                await searchItemsIndividually(items, resultsContainer);
                searchBtn.disabled = false;
                searchBtn.textContent = "Search";
                return;
              } else if (
                errorData.detail.includes("No stores within the radius")
              ) {
                throw new Error("NO_STORES_FOUND");
              }
            }

            throw new Error(
              `API_ERROR:${errorData.detail || response.statusText}`
            );
          }

          const data = await response.json();
          console.log("Received data:", data);

          displayResults(data, items);
        } catch (error) {
          console.error("Error fetching prices:", error);

          let errorMsg = error.message;
          let errorDetails = "";

          if (error.message === "NO_STORES_FOUND") {
            resultsContainer.innerHTML = `
              <div class="error-message">
                üìç No stores found within 50km radius
              </div>
              <div class="empty-state">
                <div class="empty-state-icon">üè™</div>
                <h3>No nearby stores</h3>
                <p>Try expanding your search radius or check your location settings</p>
              </div>
            `;
          } else if (error.message.startsWith("API_ERROR:")) {
            const apiErrorMsg = error.message.split(":")[1];
            resultsContainer.innerHTML = `
              <div class="error-message">
                ‚ö†Ô∏è API Error: ${apiErrorMsg}
              </div>
              <div class="empty-state">
                <div class="empty-state-icon">üòï</div>
                <h3>Unable to fetch prices</h3>
                <p>Please try again or contact support</p>
              </div>
            `;
          } else if (error.message.includes("Failed to fetch")) {
            errorMsg = "Cannot connect to the server";
            errorDetails = `
              <p style="margin-top: 10px; font-size: 0.95rem;">
                Please check:<br>
                ‚Ä¢ Is your backend server running?<br>
                ‚Ä¢ Is ngrok tunnel active?<br>
                ‚Ä¢ Is CORS enabled on your backend?<br>
                ‚Ä¢ Current API URL: ${API_BASE_URL}
              </p>
            `;
            resultsContainer.innerHTML = `
              <div class="error-message">
                ‚ö†Ô∏è ${errorMsg}
                ${errorDetails}
              </div>
              <div class="empty-state">
                <div class="empty-state-icon">üòï</div>
                <h3>Unable to fetch prices</h3>
                <p>Check the browser console for more details</p>
              </div>
            `;
          } else {
            resultsContainer.innerHTML = `
              <div class="error-message">
                ‚ö†Ô∏è ${errorMsg}
              </div>
              <div class="empty-state">
                <div class="empty-state-icon">üòï</div>
                <h3>Something went wrong</h3>
                <p>Please try again or check the console for details</p>
              </div>
            `;
          }
        } finally {
          searchBtn.disabled = false;
          searchBtn.textContent = "Search";
        }
      }

      function displayResults(data, searchedItems) {
        const resultsContainer = document.getElementById("resultsContainer");

        if (
          !data ||
          !data.single_store_totals ||
          data.single_store_totals.length === 0
        ) {
          if (data && data.items && data.items.length === 0) {
            resultsContainer.innerHTML = `
              <div class="error-message">
                üö´ Products Not Available
              </div>
              <div class="unavailable-items">
                <h3>‚ùå None of these items are for sale</h3>
                <p>The following items are not available in any nearby stores:</p>
                <ul>
                  ${searchedItems
                    .map((item) => `<li><strong>${item}</strong></li>`)
                    .join("")}
                </ul>
                <p style="margin-top: 15px; color: #856404;">
                  üí° Please try searching for different items.
                </p>
              </div>
            `;
          } else {
            resultsContainer.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">üòï</div>
                <h3>No results found</h3>
                <p>Try searching for different items or expand your search radius</p>
              </div>
            `;
          }
          return;
        }

        const normalizedSearchedItems = searchedItems.map((item) =>
          item.toLowerCase().trim()
        );
        const normalizedDataItems = data.items.map((item) =>
          item.toLowerCase().trim()
        );

        const unavailableItems = searchedItems.filter(
          (item, index) =>
            !normalizedDataItems.includes(normalizedSearchedItems[index])
        );

        const storeMap = {};
        if (data.stores && Array.isArray(data.stores)) {
          data.stores.forEach((store) => {
            storeMap[store.id] = store;
          });
        }

        const storeResults = data.single_store_totals
          .map((storeTotal) => {
            const storeInfo = storeMap[storeTotal.store_id] || {};
            const storeItems = data.prices
              .filter((price) => price.store_id === storeTotal.store_id)
              .map((price) => ({
                name: price.item,
                price: price.price.toFixed(2),
                unit: price.unit,
              }));

            const isBestStore =
              data.best_single_store &&
              data.best_single_store.store_id === storeTotal.store_id;

            return {
              store_id: storeTotal.store_id,
              store_name: storeInfo.name || storeTotal.store_id,
              distance: storeInfo.distance_km
                ? storeInfo.distance_km.toFixed(1)
                : "N/A",
              items: storeItems,
              total: storeTotal.total.toFixed(2),
              is_best: isBestStore,
            };
          })
          .sort((a, b) => parseFloat(a.total) - parseFloat(b.total));

        let html = "";

        if (unavailableItems.length > 0) {
          html += `
            <div class="unavailable-items">
              <h3>üö´ Items Not For Sale</h3>
              <p>The following ${
                unavailableItems.length === 1 ? "item is" : "items are"
              } not currently available in any nearby stores:</p>
              <ul>
                ${unavailableItems
                  .map(
                    (item) =>
                      `<li><strong>${item}</strong> - Not available for purchase</li>`
                  )
                  .join("")}
              </ul>
              <p style="margin-top: 12px; font-size: 0.95rem; color: #856404;">
                üí° <strong>Tip:</strong> Try searching for similar items or check back later.
              </p>
            </div>
          `;
        }

        html += `
          <h2 class="section-title">Price Comparison Results</h2>
          <div class="results-grid">
            ${storeResults
              .map(
                (store) => `
              <div class="store-card">
                <div class="store-header">
                  <div class="store-name">
                    <span>üè™</span>
                    ${store.store_name}
                    ${
                      store.is_best
                        ? '<span class="best-store-badge">üèÜ Best Deal</span>'
                        : ""
                    }
                  </div>
                  <div class="store-distance">üìç ${store.distance} km</div>
                </div>
                <div class="items-list">
                  ${store.items
                    .map(
                      (item) => `
                    <div class="item-row">
                      <span class="item-name">${item.name} ${
                        item.unit ? `(${item.unit})` : ""
                      }</span>
                      <span class="item-price">$${item.price}</span>
                    </div>
                  `
                    )
                    .join("")}
                </div>
                <div class="store-total">
                  <span class="total-label">Total Price</span>
                  <span class="total-price">$${store.total}</span>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;

        resultsContainer.innerHTML = html;
      }

      document.getElementById("searchInput").addEventListener("keyup", (e) => {
        if (e.key === "Enter") searchPrices();
      });

      function toggleMobileMenu() {
        const navMenu = document.getElementById("navMenu");
        const menuOverlay = document.getElementById("menuOverlay");
        const menuToggle = document.querySelector(".mobile-menu-toggle");

        navMenu.classList.toggle("active");
        menuOverlay.classList.toggle("active");

        if (navMenu.classList.contains("active")) {
          menuToggle.textContent = "‚úï";
        } else {
          menuToggle.textContent = "‚ò∞";
        }
      }
    </script>
  </body>
</html>
